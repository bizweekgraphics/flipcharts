<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">

  <link href="favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon" />
  <link href="apple-touch-icon-precomposed.png" rel="apple-touch-icon" type="image/png" />

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/h5bp.css">
  <link rel="stylesheet" href="css/bbw.css">
  <script src="js/vendor/modernizr-2.6.2.min.js"></script>
  <script type="text/javascript" src="js/vendor/iscroll.js"></script>
</head>

<script type="text/javascript">

var myScroll;

function loaded () {
  myScroll = new IScroll('#wrapper', {
    scrollX: true,
    scrollY: false,
    momentum: false,
    snap: true,
    snapSpeed: 400,
    keyBindings: true,
    indicators: {
      el: document.getElementById('indicator'),
      resize: false
    }
  });
}

document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
</script>

<style type="text/css">
* {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

html {
  -ms-touch-action: none;
  width: 100%;
  height: 100%;
}

body, ul, li {
  padding: 0;
  margin: 0;
  border: 0;
}

body {
  font-size: 12px;
  font-family: ubuntu, helvetica, arial;
  overflow: hidden; /* this is important to prevent the whole page to bounce */
  width: 100%;
  height: 100%;
  background: url(img/scribble_light.png);
}

#viewport {
  position: relative;
  width: 100%;
  height: 100%;
  margin: 0 auto;
  overflow: hidden;
}

#wrapper {
  width: 100%;
  height: 100%;
  margin: 0 auto;
}

#scroller {
  position: absolute;
  z-index: 1;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
  width: 400%;
  height: 100%;
  -webkit-transform: translateZ(0);
  -moz-transform: translateZ(0);
  -ms-transform: translateZ(0);
  -o-transform: translateZ(0);
  transform: translateZ(0);
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-text-size-adjust: none;
  -moz-text-size-adjust: none;
  -ms-text-size-adjust: none;
  -o-text-size-adjust: none;
  text-size-adjust: none;
}

.slide {
  width: 25%;
  height: 100%;
  float: left;
  font-family: BWHaasRegular;
  text-align: center;
  font-size: 13pt;
  position: relative;
}

.slide-inner {
  width: 100%;
  height: 100%;
  padding: 20px;
}

.slide svg {
  position: absolute;
  top:0;
  left:0;
}

.axis line, .axis path {
  fill: none;
  stroke: none;
}

.y.axis {
  font-size: 10pt;
}

h2 {
  font-family: BWHaasHead;
  font-size: 20pt;
}

#indicator {
  position: absolute;
  z-index: 1;
  bottom: 0px;
  width: 100%;
  height: 5px;
}

#dotty {
  position: absolute;
  width: 25%;
  height: 5px;
  background: #666;
}

/* from pure css http://purecss.io/buttons/ */
button {
  font-family: BWHaasHead;
  font-size: 100%;
  padding: .5em 1.5em;
  color: #444;
  color: rgba(0,0,0,.8);
  border: 1px solid #999;
  border: 0 rgba(0,0,0,0);
  background-color: #E6E6E6;
  text-decoration: none;
  border-radius: 2px;
  -webkit-transition: .1s linear -webkit-box-shadow;
  -moz-transition: .1s linear -moz-box-shadow;
  -ms-transition: .1s linear box-shadow;
  -o-transition: .1s linear box-shadow;
  transition: .1s linear box-shadow;
  display: inline-block;
  zoom: 1;
  line-height: normal;
  white-space: nowrap;
  vertical-align: baseline;
  text-align: center;
  cursor: pointer;
  -webkit-user-drag: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-appearance: button;
  cursor: pointer;
  margin: 0;
  box-sizing: border-box;
  align-items: flex-start;
}

button:hover {
  background-image: linear-gradient(transparent,rgba(0,0,0,.05) 40%,rgba(0,0,0,.1));
}

.up-for-more {
  position: absolute;
  top: 0;
  right: 0;
  -webkit-transform: rotate(180deg);
}

@media (min-width: 640px) {
  /* desktop view */

  #viewport {
    width: 100%;
    height: 480px;
    background: none;
    top: 20%;
  }

  #wrapper {
    width: 320px;
    height: 100%;
    background: none;
  }

  #scroller {
    width: 1280px;
    height: 100%;
  }

}

</style>

<!--
Body classes:
.iframed    // no interface wrapping, no margins
.dark_layout  // like bbw video site
.half      // half-width of standard article (315px)
.full      // full-width of standard article (630px)
.wide      // wide interactive feature layout (970px)

Fonts:
font-family:BloombergLBold    // corporate wordmark logotype
font-family:BWHaasHead
font-family:BWHaasHead75Bold
font-family:BWHaasRegular
-->

<body onload="loaded()">

  <div id="viewport">
    <div id="wrapper">
      <div id="scroller">
        <div class="slide" id="slide1">
          <div class="slide-inner">
            <h2>①<br/>Oils spills from tankers are down</h3>
            <p class="dek"></p>
          </div>
        </div>
        <div class="slide" id="slide2">
          <div class="slide-inner">
            <h2>②<br/>for three reasons</h3>
            <p>1. Better regulation</p>
            <p>2. Better engineering</p>
            <p>3. Better maps</p>
          </div>
        </div>
        <div class="slide" id="slide3">
          <div class="slide-inner">
            <h2>③<br/>but other sources have picked up the slack</h3>
              <img src="img/down.png" width="40" class="up-for-more">
          </div>
        </div>
        <div class="slide" id="slide4">
          <div class="slide-inner">
            <a href="http://businessweek.com/" title="Bloomberg Businessweek"><img src="apple-touch-icon-precomposed.png" width="50"></a>
            <h2 id="title">Oil spill title</h2>
            <p id="description">This is dek, different from the dek you are at now. I am typing the sound of my dek and I repeating and repeating the dek dek dek TK sound of my speaking voice.</p>
            <a id="story-link" href="#"><button>Read article</button></a>
            <div class="data-credit">Data: compiled by Bloomberg</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="indicator">
    <div id="dotty"></div>
  </div>

  <!--
  <svg id="svg-canvas" class="fullscreen">
    <defs>
      <marker id = "arrowhead" viewBox = "-10 -10 20 20" refX = "0" refY = "0" markerWidth = "20" markerHeight = "20" stroke-width = "1" orient = "auto">
        <polyline class="arrow" stroke-linejoin="bevel" points="-6.72,-6.749 0.54,0 -6.72,6.749 "/>
      </marker>
    </defs>
  </svg>
  -->

  <script src="js/vendor/d3.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.2.min.js"><\/script>')</script>
  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>

  <script>

// LOAD DATA FROM ALL SOURCES
var dataSources = [
  { name: "Total spills", src: "totalspills.tsv" },
  { name: "Tanker spills", src: "tankerspills.tsv" }
  ]

// files remaining
var activeAJAX = dataSources.length;

var data = new Object();

dataSources.forEach(function(dataSource, i) {
  if(dataSource.src) {
    d3.tsv("data/"+dataSource.src, function(error, dataLoaded) {
      //coercing from strings to numbers
      dataLoaded.forEach(function(d, i) {
        $.each(d, function(j, value) {
          dataLoaded[i][j] = +value;
        })
      });
      data[dataSource.name] = dataLoaded;
      // if all files have been loaded...
      if (--activeAJAX == 0) {
        render();
        slides = d3.selectAll(".slide");
      }
    });
  } else { render(); }
});

//////////////////////////////////////////////////////////////////////////////////////////
// RENDER ////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////

function render() {
  barChart(d3.select("#slide1"),data["Tanker spills"],"Tanker spills");
  barChart(d3.select("#slide3"),data["Total spills"],"Total spills");
}

//////////////////////////////////////////////////////////////////////////////////////////
// CHARTER ///////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////

var charts = new Object();
function barChart(parent, data, name) {

  var margin = {top: 40, right: 20, bottom: 40, left: 10},
      width = $(parent.node()).width() - margin.left - margin.right,
      height = $(parent.node()).height() - margin.top - margin.bottom;

  var x = d3.scale.ordinal()
      .rangeRoundBands([0, width], .1);

  var y = d3.scale.linear()
      .range([height, 0]);

  var xAxis = d3.svg.axis()
      .scale(x)
      .tickValues(d3.extent(data, function(d) { return d.year; }))
      .orient("bottom");

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("right")
      .tickFormat(bbwNumberFormat)
      .ticks(10, ""); //"%"

  var svg = parent.append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // this shouldn't really be a category axis...
  x.domain(data.map(function(d) { return d.year; }));

  // somewhat tortured way to force y scale to include 0, be it above max or below min
  var yExtent = d3.extent(data, function(d) { return d.value; });
  yExtent.push(0);
  y.domain(d3.extent(yExtent));

  if(name=="Total spills") {
    y.domain([0,25e6]);
  }

  var xAxisGroup = svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  var yAxisGroup = svg.append("g")
      .attr("class", "y axis")
      .attr("transform", "translate("+(width-20)+",0)")
      .call(yAxis);

  var bars = svg.selectAll(".bar")
      .data(data)
    .enter().append("rect")
      .attr("class", "bar")
      .attr("x", function(d) { return x(d.year); })
      .attr("width", x.rangeBand())
      .attr("y", function(d) { return y(Math.max(0, d.value)); })
      .attr("height", function(d) { return Math.abs(y(d.value) - y(0)); });

  charts[name] = {
    "svg": svg,
    "bars": bars,
    "data": data,
    "x": x,
    "y": y,
    "xAxis": xAxis,
    "yAxis": yAxis,
    "xAxisGroup": xAxisGroup,
    "yAxisGroup": yAxisGroup
  };

}

d3.select("#slide3").on("click", deepwater);
d3.select("#slide3").on("touchstart", deepwater);

function deepwater() {
  charts["Total spills"].y.domain([0,2.15e8]);
  charts["Total spills"].yAxis.scale(charts["Total spills"].y);
  charts["Total spills"].yAxisGroup
    .transition().duration(1000)
    .call(charts["Total spills"].yAxis);
  charts["Total spills"].bars
    .data(charts["Total spills"].data)
    .transition().duration(1000)
    .attr("y", function(d) { return charts["Total spills"].y(Math.max(0, d.value)); })
    .attr("height", function(d) { return Math.abs(charts["Total spills"].y(d.value) - charts["Total spills"].y(0)); })
  d3.select(".up-for-more").remove();
}
  </script>

</body>
</html>
